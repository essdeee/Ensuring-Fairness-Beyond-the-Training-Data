


\begin{lemma}
If $\delta^w_{DP}(f) \le \epsilon$ for any weight $w \in \Nc(\gamma_1,\WW)$, then we have $\delta^w_{DP}(f) \le \epsilon + 4\gamma_1$ for any weight $w \in \WW$.
\end{lemma}
\begin{proof}
Recall the definition of demographic parity with respect to a weight vector $w$.
$$\delta^w_{DP}(f) = \abs{ \frac{\sum_{i: a_i = a} w_i f(x_i,a)}{\sum_{i: a_i = a} w_i} -  \frac{\sum_{i: a_i = a'} w_i f(x_i,a')}{{\sum_{i: a_i = a'} w_i}} }$$ 
For a given weight $w$, we construct a new weight $w' = (w'_1,\ldots,w'_n)$ as follows. For each $i \in [n]$, $w'_i$ is the upper-end point of the bucket containing $w_i$. Note that this guarantees that either $w_i\le \delta$ or $\frac{w'_i}{1+\gamma_1} \le w_i \le w_i'$. We now establish the following lower bound.
\begin{align}\label{eq:lbd-ratio}
\frac{\sum_{i: a_i = a} w_i f(x_i,a)}{\sum_{i: a_i = a} w_i} \ge \frac{1}{1+\gamma_1}  \frac{\sum_{i: a_i = a} w_i' f(x_i,a)}{\sum_{i: a_i = a} w_i'} \ge (1-\gamma_1) \frac{\sum_{i: a_i = a} w_i' f(x_i,a)}{\sum_{i: a_i = a} w_i'} 
\end{align}
Also note that,
\begin{align*}
\sum_{i: a_i = a} w_i' &\le \sum_{i:a_i = a, w_i > \delta} w_i + \sum_{i: a_i = a, w_i \le \delta} \delta 
\le (1+\gamma_1) \sum_{i:a_i = a, w_i > \delta} w_i' + n \delta
\end{align*}
This gives us the following.
\begin{align*}
\frac{\sum_{i: a_i = a} w_i f(x_i,a)}{\sum_{i: a_i = a} w_i} \le \frac{\sum_{i: a_i = a} w_i' f(x_i,a)}{\frac{1}{1+\gamma_1}\sum_{i: a_i = a} w_i' - \frac{n\delta}{1+\gamma_1} }  \le (1+\gamma_1) \frac{\sum_{i: a_i = a} w_i' f(x_i,a)}{\sum_{i: a_i = a} w_i' - n\delta } 
\end{align*}
Now we substitute, $\delta=\gamma_1/(2n)$ and get the following upper bound.
\begin{align}%\label{eq:ubd-ratio}
\frac{\sum_{i: a_i = a} w_i f(x_i,a)}{\sum_{i: a_i = a} w_i} &\le (1+\gamma_1) \frac{\sum_{i: a_i = a} w_i' f(x_i,a)}{\sum_{i: a_i = a} w_i' - \gamma_1/2}\nonumber \\ &\le \frac{1+\gamma_1}{1-\gamma_1} \frac{\sum_{i: a_i = a} w_i' f(x_i,a)}{\sum_{i: a_i = a} w_i'} \le (1+3\gamma_1)  \frac{\sum_{i: a_i = a} w_i' f(x_i,a)}{\sum_{i: a_i = a} w_i'}\label{eq:ubd-ratio}
\end{align}
% \begin{align*}
% &\frac{\sum_{i: a_i = a} w_i f(x_i,a) - \norm{w - w'}_1}{\sum_{i: a_i = a} w_i + \norm{w - w'}_1} \le \frac{\sum_{i: a_i = a} w_i f(x_i,a)}{\sum_{i: a_i = a} w_i} \le \frac{\sum_{i: a_i = a} w_i f(x_i,a) + \norm{w - w'}_1}{\sum_{i: a_i = a} w_i - \norm{w - w'}_1} \\
% \iff &\frac{\sum_{i: a_i = a} w_i f(x_i,a) - \eps/4}{\sum_{i: a_i = a} w_i + \eps/4} \le \frac{\sum_{i: a_i = a} w_i f(x_i,a)}{\sum_{i: a_i = a} w_i} \le \frac{\sum_{i: a_i = a} w_i f(x_i,a) + \eps/4}{\sum_{i: a_i = a} w_i - \eps/4} \\
% \iff & \frac{\sum_{i: a_i = a} w_i f(x_i,a) - \eps/4}{1/2\sum_{i: a_i = a} w_i} \le \frac{\sum_{i: a_i = a} w_i f(x_i,a)}{\sum_{i: a_i = a} w_i} \le  \frac{\sum_{i: a_i = a} w_i f(x_i,a) + \eps/4}{1/2\sum_{i: a_i = a} w_i}
% \end{align*}
Now we bound $\delta^w_{DP}(f)$ using the results above. Suppose $\frac{\sum_{i: a_i = a} w_i f(x_i,a)}{\sum_{i: a_i = a} w_i} >  \frac{\sum_{i: a_i = a'} w_i f(x_i,a')}{\sum_{i: a_i = a'} w_i}$. Then we have,
%\begin{align*}
%\delta^w_{DP}(f) = \frac{\sum_{i: a_i = a} w_i f(x_i,a)}{\sum_{i: a_i = a} w_i} -  \frac{\sum_{i: a_i = a'} w_i f(x_i,a')}{\sum_{i: a_i = a'} w_i}
%\end{align*}
%Then we have,
\begin{align*}
\delta^w_{DP}(f) &\le (1+3\gamma_1)  \frac{\sum_{i: a_i = a} w_i' f(x_i,a)}{\sum_{i: a_i = a} w_i'} - (1-\gamma_1) \frac{\sum_{i: a_i = a} w_i' f(x_i,a)}{\sum_{i: a_i = a} w_i'}  \\
&\le  \frac{\sum_{i: a_i = a} w_i' f(x_i,a)}{\sum_{i: a_i = a} w_i'} -  \frac{\sum_{i: a_i = a} w_i' f(x_i,a)}{\sum_{i: a_i = a} w_i'} + 4\gamma_1\\
&\le \delta^{w'}_{DP}(f) + 4\gamma_1
\end{align*}
The first inequality uses the upper bound for the first term (eq. \ref{eq:ubd-ratio}) and the lower bound for the second term (eq. \ref{eq:lbd-ratio}). The proof when the first term is less than the second term in the definition of $\delta^w_{DP}(f)$ is similar. Therefore, if we guarantee that $\delta^{w'}_{DP}(f) \le \eps$, we have $\delta^w_{DP}(f) \le \eps+4\gamma_1$.
\end{proof}

\begin{lemma}
Algorithm \ref{algo:best-lambda} is an $B(4\gamma_1 + \gamma_2)$-approximate best response for the $\lambda$-player i.e. for any $h \in \HH$, it returns $\lambda^*$ such that
$$U(h,\lambda^*) \ge \max_{\lambda} U(h,\lambda) - B(4\gamma_1 + \gamma_2).$$
\end{lemma}
\begin{proof}
We need to consider two cases. First, suppose that $T(w,a,h) - T(w,a',h) \le \eps - 4\gamma_1$ for all $w \in \Nc(\gamma_1,\WW)$ and $a,a' \in \Ac$. Then, $\delta^w_{DP}(h) = \sup_{a,a'\in \Ac} \abs{T(w,a,h) - T(w,a',h)} \le \eps - 4\gamma_1$ for any weight $w \in \Nc(\gamma_1,\WW)$. Therefore, by lemma \ref{lem:discrete-weights}, for any weight $w \in \WW$, we have $\delta^w_{DP}(h) \le \eps$. 
Now, for any marginal $\pi \in \Pi(\gamma_2,\Ac)$, and $a,a'$ consider the corresponding linear program. We show that the optimal value of the LP is bounded by $\eps$. Indeed, consider any weight $w$ satisfying the marginal conditions i.e. $\sum_{i:a_i = a} w_i = \pi_a$ and $\sum_{i:a_i = a'} w_i = \pi_{a'}$. Then, the objective of the LP is 
$$\frac{1}{\pi_a} \sum_{i:a_i = a} w_i h(x_i,a) - \frac{1}{\pi_{a'}} \sum_{i:a_i = a'} w_i h(x_i,a') \le \sup_{w \in \WW} \delta^w_{DP}(h) \le \eps.$$
This implies that the optimal value of the LP is always less than $\eps$. So algorithm \ref{algo:best-lambda} returns the zero vector, which is also the optimal solution in this case.

Second, there exists $w \in \Nc(\gamma_1,\WW)$ and groups $a,a'$ such that $T(w,a,h) - T(w,a',h) > \eps - 4\gamma_1$ and in particular let $(w^*,a^*_1,a^{*}_2) \in \argmax_{w,a,a'} T(w,a,h) - T(w,a',h)$. Then the optimal solution sets $\lambda^{a^*_1,a^{*}_2}_{w^*}$ to $B$ and everything else to zero. Let $\pi_{a^*_1}$ and $\pi_{a^{*}_2}$ be the corresponding marginals for groups $a^*_1$ and $a^*_2$, and let $\pi'_{a^*_1}$ and $\pi'_{a^{*}_2}$ be the upper-end points of the buckets containing $\pi_{a^*_1}$ and $\pi_{a^{*_2}}$ respectively. 
%
As $\pi_{a^*_1}$ is marginal for a weight belonging to the set $\Nc(\gamma_1,\WW)$ and any weight in $\Nc(\gamma_1,\WW)$ puts at least $2\gamma_1/n$ on any training instance, we are always guaranteed that 
$$\pi_{a^*_1} \ge \frac{2\gamma_1}{n} \ge \frac{\delta}{1+\gamma_2}.$$
This guarantees the following inequalities
$$ \frac{\pi'_{a^*_1}}{1 + \gamma_2} \le \pi_{a^*_1} \le \pi'_{a^*_1}.$$
Similarly, we can show that
$$\frac{\pi'_{a^{*}_2}}{1 + \gamma_2} \le \pi_{a^{*}_2} \le \pi'_{a^{*}_2}.$$
Now, consider the LP corresponding to the marginal $\pi'$ and subgroups $a^*_1$ and $a^{*}_2$. 
\begin{align*}
&\frac{1}{\pi'_{a^*_1}} \sum_{i:a_i = a^*_1} w_i h(x_i,a^*_1) - \frac{1}{\pi'_{a^{*}_2}} \sum_{i:a_i = a^{*}_2} w_i h(x_i,a^{*}_2) \\
&\ge \frac{1}{(1+\gamma_2) \pi_{a^*_1}} \sum_{i:a_i = a^*_1} w_i h(x_i,a^*_1) - \frac{1}{\pi_{a^{*}_2}} \sum_{i:a_i = a^{*}_2} w_i h(x_i,a^{*}_2)  \\
&\ge (1-\gamma_2) T(w,a^*_1,h) - T(w,a^{*}_2,h)\\
&\ge T(w,a^*_1,h) - T(w,a^{*}_2,h) - \gamma_2
\end{align*}
Therefore, if the maximum value of $T(w,a,h) - T(w,a',h)$ over all weights $w$ and subgroups $a,a'$ is larger than $\eps + \gamma_2$, the value of the corresponding LP will be larger than $\eps$ and the algorithm will set the correct coordinate of $\lambda$ to $B$. On the other hand, if the maximum value of $T(w,a,h) - T(w,a',h)$ is between $\eps - 4\gamma_1$ and $\eps+\gamma_2$. In that case, the algorithm might return the zero vector with value zero. However, the optimal value in that case can be as large as $B \times (4\gamma_1 + \gamma_2)$.
\end{proof}

\begin{lemma}[Restated theorem 5.6 from \cite{Hazan16}]\label{thm:rftl-guarantee}
The RFTL algorithm achieves the following regret bound for any $u \in \Kc$
$$\sum_{t=1}^T f_t(x_t) - f_t(u) \le \frac{\eta}{4} \sum_{t=1}^T \norm{\nabla f_t(x_t)}_{\infty}^{2} + \frac{R(u) - R(x_1)}{2 \eta}$$
Moreover, if $\norm{\nabla f_t(x_t)}_{\infty} \le G_R$ for all $t$ and $R(u) - R(x_1) \le D_R$ for all $u \in \Kc$, then we can optimize $\eta$ to get the following bound: $\sum_{t=1}^T f_t(x_t) - f_t(u) \le D_R G_R \sqrt{T}$.
\end{lemma}

\begin{theorem}
Given a desired fairness level $\eps$, if algorithm \ref{algo:inner} is run for $T= O\left(\frac{n}{\eps^2} \right)$ rounds, then the ensemble hypothesis $\hat{h}$ provides the following guarantees:
$$\sum_{i=1}^n w^0_i \ell(\hat{h}(x_i,a_i),y_i) \le \min_{h \in \HH}\sum_{i=1}^n w^0_i \ell({h}(x_i,a_i),y_i) + O(\eps)$$
and
$$\forall w \in \WW\quad \delta^w_{DP}(\hat{h}) \le 2\eps.$$
\end{theorem}
\begin{proof}
The statement of this theorem follows from two lemmas. Lemma \ref{lem:approx-minmax} proves that if algorithm \ref{algo:inner} is run for $T$ rounds, it computes a $(2M + B)\sqrt{n/T} + B(4\gamma_1 + \gamma_2)$-minmax equilibrium of the game $U(h,\lambda)$. On the other hand, lemma \ref{lem:minmax-to-soln} proves that any $\nu$-approximate solution $(\hat{h},\hat{\lambda})$ of the game $U(h,\lambda)$ has two properties
\begin{enumerate}
\item $\hat{h}$ minimizes training loss with respect to the weight $w^0$ up to an additive error of $2\nu$.
\item $\hat{h}$ provides $\eps$-fairness guarantee with respect to the set of all weights in $\WW$ upto an additive error fo $\frac{M + 2\nu}{B}$.
\end{enumerate}
Now substituting $\nu = (2M + B)\sqrt{n/T} + B(4\gamma_1 + \gamma_2)$ we get the following two guarantees:
$$\sum_{i=1}^n w^0_i \ell(\hat{h}(x_i,a_i),y_i) \le \min_{h \in \HH}\sum_{i=1}^n w^0_i \ell({h}(x_i,a_i),y_i) + 2(2M+B)\sqrt{\frac{n}{T}} + 2B(4\gamma_1 + \gamma_2)$$
and 
$$\forall w \in \WW\quad \delta^w_{DP}(\hat{h}) \le \eps + \frac{M}{B} + 2(4\gamma_1 + \gamma_2) + \left(1 + \frac{2M}{B} \right)\sqrt{\frac{n}{T}}.$$
Now we can set the following values for the parameters $B=3M/\eps$, $T=36n/\eps^2$, $4\gamma_1 + \gamma_2 = \eps/6$, and get the desired result. \dm{Note to self: check the derivation.}
\end{proof}

\begin{lemma}\label{lem:approx-minmax}
Suppose $\abs{\ell(y,\hat{y})} \le M$ for all $y,\hat{y}$. Then algorithm \ref{algo:inner} computes a $(2M + B)\sqrt{n/T} + B(4\gamma_1 + \gamma_2)$-approximate minmax equilibrium of the game $U(h,\lambda)$ for $h \in \HH$ and $\lambda \in \bbR^{\abs{N(\gamma_1,\WW)}\times \abs{\Ac}^2}_+, \norm{\lambda}_1 \le B$. 
\end{lemma}
\begin{proof}
At round $t$, the cost is linear in $h_t$ i.e. $f_t(h_t) = \sum_{i=1}^n L(\lambda_t)_i h_t(x_i,a_i)$. Let us write $\bar{\lambda} = \frac{1}{T} \lambda_t$ and $D$ to be the uniform distribution over $h_1,\ldots,h_T$. Since we chose $R(x) = 1/2 \norm{x}_2^2$ as the regularization function and the actions are $[0,1]$ vectors in $n$-dimensional space, the diameter $D_R$ is bounded by $\sqrt{n}$. On the other hand, $\norm{\nabla f_t(h_t)}_{\infty} = \max_i \abs{L(\lambda_t)_i} $. We now bound $\abs{L(\lambda_t)_i}$ for an arbitrary $i$. Suppose $y_i=1$. The proof when $y=0$ is identical.
\begin{align*}
\abs{L(\lambda_t)_i} = \abs{c^1_i - c^0_i} = &\abs{w^0_i}\abs{\ell(0,1) - \ell(1,1)} + \abs{\Delta_i} \\
&\le 2M + B
\end{align*}
The last line follows as $w^0_i \le 1$ and since $\lambda_t$ is an approximate best reponse computed by algorithm \ref{algo:best-lambda}, exactly one $\lambda$ variable is set to $B$.
Therefore, by theorem \ref{thm:rftl-guarantee}, for any hypothesis $h \in \HH$,
\begin{align}
&\sum_{t=1}^T \sum_{i=1}^n L(\lambda_t)_i h_t(x_i,a_i) - \sum_{i=1}^n L(\lambda_t)_i h(x_i,a_i) \le (2M + B)\sqrt{nT}\nonumber \\
\Leftrightarrow &\sum_{t=1}^T U(h_t,\lambda_t) - U(h,\lambda_t) \le (2M + B)\sqrt{nT}\nonumber \\
\Leftrightarrow &\frac{1}{T} \sum_{t=1}^T U(h_t,\lambda_t) \le U(h,\bar{\lambda}) + \frac{(2M + B)\sqrt{n}}{\sqrt{T}} \label{eq:minmax-1}
\end{align}
On the other hand, $\lambda_t$ is an approximate $B(4\gamma_1 + \gamma_2)$-approximate best response to $h_t$ for each round $t$. Therefore, for any $\lambda$ we have,
\begin{align}
&\sum_{t=1}^T U(h_t,\lambda_t) \ge \sum_{t=1}^T U(h_t,\lambda) - BT(4\gamma_1 + \gamma_2)\nonumber \\
\Leftrightarrow &\frac{1}{T} \sum_{t=1}^T U(h_t,\lambda_t) \ge \E_{h \sim D} U(h,\lambda) - B(4\gamma_1 + \gamma_2) \label{eq:minmax-2}
\end{align}
Equations \ref{eq:minmax-1} and \ref{eq:minmax-2} immediately imply that the distribution $D$ and $\bar{\lambda}$ is a $(2M + B)\sqrt{n/T} + B(4\gamma_1 + \gamma_2)$-approximate equilibrium of the game $U(h,\lambda)$ (\cite{FS96}).
\end{proof}

%The next theorem establishes the guarantees of the approximate minmax solution. The proof is similar to the proof of theorem 4.5 from \cite{KNRZ17}.
\begin{lemma}\label{lem:minmax-to-soln}
Let $(\hat{h},\hat{\lambda})$ be a $\nu$-approximate minmax equilibrium of the game $U(h,\lambda)$. Then,
$$\sum_{i=1}^n w^0_i \ell(\hat{h}(x_i,a_i),y_i) \le \min_{h \in \HH}\sum_{i=1}^n w^0_i \ell({h}(x_i,a_i),y_i) + 2\nu$$
and 
$$\forall w \in \WW\quad \delta^w_{DP}(\hat{h}) \le \eps + \frac{M + 2\nu}{B}$$
\end{lemma}
\begin{proof}
Let $(\hat{h},\hat{\lambda})$ be a $\nu$-approximate minmax equilibrium of the game $U(h,\lambda)$ i.e. 
\begin{align*}
 \forall h \quad  U(\hat{h},\hat{\lambda}) \le U(h,\hat{\lambda}) + \nu  \quad \text{ and } \quad \forall \lambda  \quad U(\hat{h},\hat{\lambda}) \ge U(\hat{h}, \lambda) - \nu
\end{align*}
Let $h^*$ be the optimal feasible hypothesis. First suppose that $\hat{h}$ is feasible i.e. $T(w,a,\hat{h}) - T(w,a',\hat{h}) \le \eps - 4\gamma_1$ for all $w \in N(\gamma_1,\WW)$ and $a,a' \in \Ac$. In that case, the optimal $\lambda$ is the zero vector and $\max_{\lambda} U(\hat{h},\lambda) = \sum_{i=1}^n w^0_i \ell(h(x_i,a_i),y_i)$. Therefore,
\begin{align*}
\sum_{i=1}^n w^0_i \ell(\hat{h}(x_i,a_i),y_i) = \max_{\lambda} U(\hat{h},\lambda) \le U(\hat{h},\hat{\lambda}) + \nu \le U(h^*,\hat{\lambda}) + 2\nu \le \sum_{i=1}^n w^0_i \ell(h^*(x_i,a_i),y_i) + 2\nu
\end{align*}
The last inequality follows because $h^*$ is feasible and $\lambda$ is non-negative. Now consider the case when $\hat{h}$ is not feasible i.e. there exists $w,a,a'$ such that $T(w,a,\hat{h}) - T(w,a',\hat{h}) > \eps - 4\gamma_1$. In that case, let $(\hat{w},\hat{a},\hat{a}')$ be the tuple with maximum violation and the optimal $\lambda$, say $\lambda^*$, sets this coordinate to $B$ and everything else to zero. Then
\begin{align*}
\sum_{i=1}^n w^0_i \ell(\hat{h}(x_i,a_i),y_i) &= U(\hat{h},\lambda^*) - B(T(\hat{w},\hat{a},\hat{h}) - T(\hat{w},\hat{a}',\hat{h}) - \eps + 4\gamma_1)\\
 &\le U(\hat{h},\lambda^*) \le U(\hat{h},\hat{\lambda}) + \nu \le U(h^*,\hat{\lambda}) + 2\nu \le \sum_{i=1}^n w^0_i \ell(h^*(x_i,a_i),y_i) + 2\nu.
\end{align*}
The previous chain of inequalities also give 
\begin{align*}
B \left( \max_{(w,a,a')}T(w,a,\hat{h}) - T(w,a',\hat{h}) -\eps + 4\gamma_1 \right)\le \sum_{i=1}^n w^0_i \ell(h^*(x_i,a_i),y_i) + 2\nu \le M + 2\nu.
\end{align*}
This implies that for all weights $w \in N(\gamma_1,\WW)$ the maximum violation of the fairness constraint is $(M + 2\nu)/ B$, which in turn implies a bound of at most $(M + 2\nu)/B + \eps$ on the fairness constraint with respect to any weight $w \in \WW$. 
\end{proof}